name: Java CI/CD with Gradle

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

concurrency:
  group: shared-server-deployment
  cancel-in-progress: false  # 실행 중인 job 취소하지 않고 대기

jobs:
  build-and-deploy:
    runs-on: self-hosted
    environment: user-cicd
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create application.yml from sample
        run: |
          cp src/main/resources/application-sample.yml src/main/resources/application.yml
          echo "application.yml created from sample"

      - name: Build with Gradle (including Testcontainers tests)
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USERNAME: ${{ secrets.POSTGRES_USERNAME }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          PASSPORT_ALGO: ${{ secrets.PASSPORT_ALGORITHM }}
          PASSPORT_EXPIRATION: ${{ secrets.PASSPORT_EXP }}
          PASSPORT_SECRET: ${{ secrets.PASSPORT_KEY }}
          KAFKA_SERVER: ${{ secrets.KAFKA_SERVER }}
          GROUP_ID: ${{ secrets.GROUP_ID }}
          EUREKA_SERVER: ${{ secrets.EUREKA_SERVER }}
          JWT_KEY: ${{ secrets.JWT_KEY }}
          SLACK_API_KEY: ${{ secrets.SLACK_API_KEY}}
        run: ./gradlew clean build

      - name: Stop existing application
        run: |
          echo "Stopping existing application on port ${{ secrets.APP_PORT }}..."
          PID=$(lsof -ti:${{ secrets.APP_PORT }}) || true
          if [ ! -z "$PID" ]; then
            echo "Found process $PID running on port ${{ secrets.APP_PORT }}"
            kill -15 $PID
            sleep 5
            if lsof -ti:${{ secrets.APP_PORT }} > /dev/null; then
              echo "Process still running, forcing kill..."
              kill -9 $(lsof -ti:${{ secrets.APP_PORT }})
            fi
            echo "Application stopped successfully"
          else
            echo "No application running on port ${{ secrets.APP_PORT }}"
          fi

      - name: Deploy new version
        run: |
          JAR_PATH="build/libs/${{ secrets.JAR_NAME }}"
          DEPLOY_DIR="${{ secrets.DEPLOY_DIR }}"
          
          mkdir -p $DEPLOY_DIR
          
          if [ -f "$DEPLOY_DIR/app.jar" ]; then
            mv "$DEPLOY_DIR/app.jar" "$DEPLOY_DIR/app.jar.bak.$(date +%Y%m%d_%H%M%S)"
          fi
          
          cp $JAR_PATH $DEPLOY_DIR/app.jar
          echo "JAR deployed"

      - name: Update environment variables
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USERNAME: ${{ secrets.POSTGRES_USERNAME }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          PASSPORT_ALGO: ${{ secrets.PASSPORT_ALGORITHM }}
          PASSPORT_EXPIRATION: ${{ secrets.PASSPORT_EXP }}
          PASSPORT_SECRET: ${{ secrets.PASSPORT_KEY }}
          KAFKA_SERVER: ${{ secrets.KAFKA_SERVER }}
          GROUP_ID: ${{ secrets.GROUP_ID }}
          EUREKA_SERVER: ${{ secrets.EUREKA_SERVER }}
          JWT_KEY: ${{ secrets.JWT_KEY }}
          SLACK_API_KEY: ${{ secrets.SLACK_API_KEY}}
        run: |
          cat > ${{ secrets.DEPLOY_DIR }}/.env << EOF
          POSTGRES_HOST=${POSTGRES_HOST}
          POSTGRES_PORT=${POSTGRES_PORT}
          POSTGRES_DB=${POSTGRES_DB}
          POSTGRES_USERNAME=${POSTGRES_USERNAME}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          REDIS_HOST=${REDIS_HOST}
          REDIS_PORT=${REDIS_PORT}
          PASSPORT_ALGO=${PASSPORT_ALGORITHM}
          PASSPORT_EXPIRATION=${PASSPORT_EXP}
          PASSPORT_SECRET=${PASSPORT_KEY}
          KAFKA_SERVER=${KAFKA_SERVER}
          GROUP_ID=${GROUP_ID}
          EUREKA_SERVER=${EUREKA_SERVER}
          JWT_KEY=${JWT_KEY}
          SLACK_API_KEY=${SLACK_API_KEY}
          EOF
          echo "Environment variables updated"

      - name: Restart application
        run: |
          $HOME/deploy/restart.sh ${{ secrets.APP_PORT }}
          
          echo "Waiting for application to start..."
          sleep 10
          
          for i in {1..30}; do
            if lsof -ti:${{ secrets.APP_PORT }} > /dev/null 2>&1; then
              echo "Application is running on port ${{ secrets.APP_PORT }}"
              ps aux | grep app.jar | grep -v grep
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          echo "Application failed to start"
          tail -100 ${{ secrets.LOG_DIR }}/app.log
          exit 1

      - name: Verify deployment
        run: |
          sleep 5
          
          if lsof -ti:${{ secrets.APP_PORT }} > /dev/null; then
            echo "Deployment successful - Application is running on port ${{ secrets.APP_PORT }}"
          else
            echo "Deployment failed - Application is not running"
            tail -50 ${{ secrets.LOG_DIR }}/app.log
            exit 1
          fi
